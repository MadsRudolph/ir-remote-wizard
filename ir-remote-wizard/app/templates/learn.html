{% extends "base.html" %}

{% block subtitle %}<p class="subtitle">Learn Mode: Capture IR codes from your remote</p>{% endblock %}

{% block progress %}
{% if session.matched_device_ids %}
<div class="progress-bar">
    <div class="step done">1. Connect</div>
    <div class="step done">2. Device</div>
    <div class="step done">3. Brand</div>
    <div class="step active">4. Discover</div>
    <div class="step">5. Results</div>
</div>
{% else %}
<div class="progress-bar">
    <div class="step done">1. Connect</div>
    <div class="step active">2. Learn</div>
    <div class="step">3. Results</div>
</div>
{% endif %}
{% endblock %}

{% block content %}

{% if saved_name is defined and saved_name %}
<div class="alert alert-success">
    <svg width="18" height="18" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd"
            d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
            clip-rule="evenodd"></path>
    </svg>
    Saved "{{ saved_name }}" button.
</div>
{% endif %}

{% if capture is defined and capture and not capture.success %}
<div class="alert alert-error">
    {{ capture.error }}
</div>
{% endif %}

<div class="glass-card">
    {% if capture is defined and capture and capture.success %}
    <div class="discovery-info">
        <h2 style="font-size: 24px;">Code Captured</h2>
        {% if capture.address or capture.command %}
        <div class="hex-display" style="margin: 20px 0;">
            {% if capture.address %}<span class="hex-pair"><span class="hex-label">Addr</span><span class="hex-value">0x{{ capture.address }}</span></span>{% endif %}
            {% if capture.command %}<span class="hex-pair"><span class="hex-label">Cmd</span><span class="hex-value">0x{{ capture.command }}</span></span>{% endif %}
        </div>
        {% endif %}
        <p class="code-info">
            Protocol: <code>{{ capture.protocol }}</code>
            {% if capture.address %} | Addr: <code>0x{{ capture.address }}</code>{% endif %}
            {% if capture.command %} | Cmd: <code>0x{{ capture.command }}</code>{% endif %}
        </p>
    </div>

    {% if tested is defined and tested %}
    <div class="alert alert-success" style="margin-top: 24px;">
        Signal sent — did your device respond?
    </div>
    {% endif %}

    <div style="margin-top: 32px;">
        <label style="color: var(--text-secondary); font-size: 14px; display: block; margin-bottom: 12px;">NAME THIS
            BUTTON</label>

        <div style="margin-bottom: 20px;">
            <span class="chip" onclick="quickSave('Power')">Power</span>
            <span class="chip" onclick="quickSave('Volume Up')">Vol +</span>
            <span class="chip" onclick="quickSave('Volume Down')">Vol -</span>
            <span class="chip" onclick="quickSave('Mute')">Mute</span>
            <span class="chip" onclick="quickSave('Source')">Source</span>
        </div>

        <form method="post" action="{{ url('/learn/save') }}" class="learn-save-form">
            <input type="hidden" name="session_id" value="{{ session_id }}">
            <input type="hidden" name="protocol" value="{{ capture.protocol }}">
            <input type="hidden" name="address" value="{{ capture.address or '' }}">
            <input type="hidden" name="command" value="{{ capture.command or '' }}">
            <input type="hidden" name="raw_data" value="{{ capture.raw_data or '' }}">
            <input type="hidden" name="pronto" value="{{ capture.pronto or '' }}">

            <div style="display: flex; gap: 12px;">
                <input type="text" id="btn_name" name="button_name" placeholder="e.g. Volume Up" required
                    style="flex: 1; padding: 12px 16px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 8px; color: white;">
                <button type="submit" class="btn btn-success">Save</button>
            </div>
        </form>

        <div style="display: flex; gap: 12px; margin-top: 16px;">
            <form method="post" action="{{ url('/learn/test') }}" style="flex: 1;">
                <input type="hidden" name="session_id" value="{{ session_id }}">
                <input type="hidden" name="protocol" value="{{ capture.protocol }}">
                <input type="hidden" name="address" value="{{ capture.address or '' }}">
                <input type="hidden" name="command" value="{{ capture.command or '' }}">
                <input type="hidden" name="raw_data" value="{{ capture.raw_data or '' }}">
                <input type="hidden" name="pronto" value="{{ capture.pronto or '' }}">
                <input type="hidden" name="display" value="{{ capture.display }}">
                <button type="submit" class="btn btn-secondary btn-wide">Test Signal</button>
            </form>
            <form method="post" action="{{ url('/learn/listen') }}" style="flex: 1;">
                <input type="hidden" name="session_id" value="{{ session_id }}">
                <button type="submit" class="btn btn-primary btn-wide">Discard & Retry</button>
            </form>
        </div>
    </div>

    {% else %}
    <div class="discovery-info" style="text-align: center;">
        <h2 style="font-size: 24px; margin-bottom: 12px;">Ready to Listen</h2>
        <p style="color: var(--text-secondary); margin-bottom: 32px;">Press <strong>Listen</strong>, then press a button
            on your physical remote.</p>

        <form method="post" action="{{ url('/learn/listen') }}">
            <input type="hidden" name="session_id" value="{{ session_id }}">
            <button type="submit" class="btn btn-primary btn-large btn-wide">Start Listening</button>
        </form>
    </div>
    {% endif %}
</div>

{% if session.confirmed_buttons %}
<div class="glass-card" style="margin-top: 32px; padding: 24px;">
    <h3 style="font-size: 16px; margin-bottom: 20px;">Saved Buttons ({{ session.confirmed_buttons | length }})</h3>
    <div style="display: flex; flex-direction: column; gap: 12px;">
        {% for btn in session.confirmed_buttons %}
        <div
            style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.03); padding: 12px 16px; border-radius: 12px;">
            <div>
                <span style="font-weight: 600; font-size: 15px;">{{ btn.name }}</span>
                <span class="badge" style="margin-left: 8px; opacity: 0.7;">{{ btn.protocol }}</span>
            </div>
            <form method="post" action="{{ url('/learn/delete') }}" class="inline-form">
                <input type="hidden" name="session_id" value="{{ session_id }}">
                <input type="hidden" name="button_index" value="{{ loop.index0 }}">
                <button type="submit" class="btn btn-danger btn-small"
                    style="background: transparent; color: var(--danger); padding: 4px; border: 1px solid rgba(239,68,68,0.2);">✕</button>
            </form>
        </div>
        {% endfor %}
    </div>

    <div style="display: flex; gap: 12px; margin-top: 24px;">
        {% if session.matched_device_ids %}
        <form method="post" action="{{ url('/learn/back-to-picker') }}" style="flex: 1;">
            <input type="hidden" name="session_id" value="{{ session_id }}">
            <button type="submit" class="btn btn-secondary btn-wide">Back to Button Picker</button>
        </form>
        {% endif %}
        <form method="post" action="{{ url('/learn/done') }}" style="flex: 1;">
            <input type="hidden" name="session_id" value="{{ session_id }}">
            <button type="submit" class="btn btn-success btn-wide">Generate Final YAML</button>
        </form>
    </div>
</div>
{% endif %}

{% endblock %}